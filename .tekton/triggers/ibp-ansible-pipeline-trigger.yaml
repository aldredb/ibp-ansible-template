---
apiVersion: tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: ibp-ansible-test-tt
spec:
  params:
    - name: token_username
      description: username of Gitlab token for repo read access
    - name: token_pwd
      description: password of Gitlab token for repo read access
    - name: git-url
      description: IBP Ansible Template git repo url
    - name: git-revision
      description: git revision to checkout (branch, tag, sha, refâ€¦)
      default: master
    - name: api_endpoint
      description: ibp console address
    - name: api_authtype
      description: ibmcloud (for IBP Sass) or basic (for IBP SW)
    - name: api_key
      description: api key for IBP SaaS or password for IBP SW
    - name: trigger-name
      default: "gitlab-push"
  resourcetemplates:
    - apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: pipeline-account
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: $(params.trigger-name)-$(uid)-pvc
      spec:
        resources:
          requests:
            storage: 2Gi
        volumeMode: Filesystem
        accessModes:
          - ReadWriteOnce
    - apiversion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: ibp-ansible-run-
      spec:
        pipelineRef:
          name: clone-and-test-pipeline
        serviceAccountName: pipeline-account
        params:
          - name: git-url
            value: "https://$(params.token_username):$(params.token_pwd)@jp-tok.git.cloud.ibm.com/ap-blockchain/ibp-ansible-template.git"
          - name: git-revision
            value: $(params.git-revision)
          - name: api-endpoint
            value: $(params.api_endpoint)
          - name: api-authtype
            value: $(params.api_authtype)
          - name: api-key
            value: $(params.api_key)
        workspaces:
          - name: git-source
            persistentVolumeClaim:
              claimName: $(params.trigger-name)-$(uid)-pvc
---
apiVersion: tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: ibp-ansible-test-tb-push
spec:
  params:
    # GitLab API https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#push-events
    - name: git-revision
      value: $(event.checkout_sha)
    - name: trigger-name
      value: "gitlab-push"
---
apiVersion: tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: ibp-ansible-test-tb-merge
spec:
  params:
    # Gitlab API: https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#merge-request-events
    - name: git-revision
      value: $(event.last_commit.id)
    - name: trigger-name
      value: "gitlab-mergerequest"
---
apiVersion: tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: ibp-ansible-test-tb-manual
spec:
  params:
    - name: git-revision
      value: "alex/#9-tekton"
    - name: trigger-name
      value: "manual-trigger"
---
apiVersion: tekton.dev/v1beta1
kind: EventListener
metadata:
  name: ibp-ansible-test-el-push
spec:
  triggers:
    - binding:
        name: ibp-ansible-test-tb-push
      template:
        name: ibp-ansible-test-tt
---
apiVersion: tekton.dev/v1beta1
kind: EventListener
metadata:
  name: ibp-ansible-test-el-merge
spec:
  triggers:
    - binding:
        name: ibp-ansible-test-tb-merge
      template:
        name: ibp-ansible-test-tt
---
apiVersion: tekton.dev/v1beta1
kind: EventListener
metadata:
  name: ibp-ansible-test-el-manual
spec:
  triggers:
    - binding:
        name: ibp-ansible-test-tb-manual
      template:
        name: ibp-ansible-test-tt
