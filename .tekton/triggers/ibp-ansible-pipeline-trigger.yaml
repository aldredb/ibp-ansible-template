---
apiVersion: tekton.dev/v1beta1
kind: TriggerTemplate
metadata:
  name: ibp-ansible-test-tt
spec:
  params:
    - name: git-url
      description: IBP Ansible Template git repo url
      default: "https://jp-tok.git.cloud.ibm.com/ap-blockchain/ibp-ansible-template"
    - name: git-revision
      description: git revision to checkout (branch, tag, sha, refâ€¦)
      default: master
    - name: api_endpoint
      description: ibp console address
    - name: api_authtype
      description: ibmcloud (for IBP Sass) or basic (for IBP SW)
    - name: api_key
      description: api key for IBP SaaS or password for IBP SW
  resourceTemplate:
    - apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: pipeline-account
    - apiversion: tekton.dev/v1beta1
      kind: PipelineRun
      metadata:
        generateName: ibp-ansible-run-
      spec:
        pipelineRef:
          name: clone-and-test-pipeline
        serviceAccountName: pipeline-account
        params:
          - name: git-url
            value: $(params.git-url)
          - name: git-revision
            value: $(params.git-revision)
          - name: api_endpoint
            value: $(params.api_endpoint)
          - name: api_authtype
            value: $(params.api_authtype)
          - name: api_secret
            value: $(params.api_secret)
        workspaces:
          - name: git-source
            volumeClaimTemplate:
              spec:
                accessModes:
                  - ReadWriteOnce
                resources:
                  Requests:
                    storage: 2Gi
---
apiVersion: tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: ibp-ansible-test-tb-push
spec:
  params:
    # GitLab API https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#push-events
    - name: git-url
      value: $(body.repository.url)
    - name: git-revision
      value: $(body.checkout_sha)
---
apiVersion: tekton.dev/v1beta1
kind: TriggerBinding
metadata:
  name: ibp-ansible-test-tb-merge
spec:
  params:
    # Gitlab API: https://docs.gitlab.com/ee/user/project/integrations/webhooks.html#merge-request-events
    - name: git-url
      value: $(body.repository.url)
    - name: git-revision
      value: $(body.last_commit.id)
---
apiVersion: tekton.dev/v1beta1
kind: EventListener
metadata:
  name: ibp-ansible-test-el-push
spec:
  triggers:
    - binding:
        name: ibp-ansible-test-tb-push
      template:
        name: ibp-ansible-test-tt
---
apiVersion: tekton.dev/v1beta1
kind: EventListener
metadata:
  name: ibp-ansible-test-el-merge
spec:
  triggers:
    - binding:
        name: ibp-ansible-test-tb-merge
      template:
        name: ibp-ansible-test-tt
