---
- name: Create channels
  hosts: localhost
  vars_files:
    - vars/common.yaml
    - vars/api.yaml
    - vars/organizations.yaml
    - vars/channels.yaml
  vars:
    # os_org_name: os
    # creator_org_name: org1
    # channel_name: samplechannel1
    os_org: "{{ vars['ordering_organization'][os_org_name] }}"
    creator_org: "{{ vars['peer_organizations'][creator_org_name] }}"
    ordering_service_msp_admin: "{{ wallet_path }}/{{ os_org.msp.admin }}.json"
    creator_org_msp_admin: "{{ wallet_path }}/{{ creator_org.msp.admin }}.json"
    channel: "{{ vars['channels'][channel_name] }}"
    channel_policies_dir: "{{ channel_policies_path }}/{{ channel_name }}"
  tasks:
    - name: Check to see if the channel already exists
      ibm.blockchain_platform.channel_block:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        operation: fetch
        ordering_service: "{{ os_org.orderer.name }}"
        identity: "{{ ordering_service_msp_admin }}"
        msp_id: "{{ os_org.msp.id }}"
        name: "{{ channel_name }}"
        target: "0"
        path: "{{ channel_config_path }}/{{ channel_name }}_genesis_block.bin"
      register: result
      failed_when: result.msg is defined and 'NOT_FOUND' not in result.msg

    - name: Create the configuration update for the new channel
      ibm.blockchain_platform.channel_config:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        operation: create
        name: "{{ channel_name }}"
        path: "{{ channel_config_path }}/{{ channel_name }}_config_update.bin"
        organizations: "{{ channel_members }}"
        policies:
          Admins: "{{ lookup('file', '{{ channel_policies_dir }}/admins-policy.yaml') | from_yaml }}"
          Readers: "{{ lookup('file', '{{ channel_policies_dir }}/readers-policy.yaml') | from_yaml }}"
          Writers: "{{ lookup('file', '{{ channel_policies_dir }}/writers-policy.yaml') | from_yaml }}"
      vars:
        # Matches the key listed in the channel.members to those of peer_organizations
        # then extract the MSP name
        channel_members: "{{ peer_organizations|
          dict2items|
          selectattr('key', 'in', channel.members)|
          list|
          map(attribute='value.msp.name')|
          list }}"
      when: result.msg is defined and 'NOT_FOUND' in result.msg

    - name: Sign the channel configuration update for the new channel
      ibm.blockchain_platform.channel_config:
        operation: sign_update
        identity: "{{ creator_org_msp_admin }}"
        msp_id: "{{ creator_org.msp.id }}"
        name: "{{ channel_name }}"
        path: "{{ channel_config_path }}/{{ channel_name }}_config_update.bin"
      when: result.msg is defined and 'NOT_FOUND' in result.msg

    - name: Apply the channel configuration update for the new channel
      ibm.blockchain_platform.channel_config:
        api_endpoint: "{{ api_endpoint }}"
        api_authtype: "{{ api_authtype }}"
        api_key: "{{ api_key }}"
        api_secret: "{{ api_secret | default(omit) }}"
        api_token_endpoint: "{{ api_token_endpoint | default(omit) }}"
        operation: apply_update
        ordering_service: "{{ os_org.orderer.name }}"
        identity: "{{ creator_org_msp_admin }}"
        msp_id: "{{ creator_org.msp.id }}"
        name: "{{ channel_name }}"
        path: "{{ channel_config_path }}/{{ channel_name }}_config_update.bin"
      when: result.msg is defined and 'NOT_FOUND' in result.msg
